{% extends 'base.html' %}
{% load pybo_filter %}
{% load static %}
{% block content %}


<div class="container my-3">
    <table class="table " style="border-top: 2px solid #222324;border-bottom: 2px solid #222324;width: fit-content;float:right;" > 
        <tr>            
            <th class="text-center " style="width: 10%;border: 1px dotted #222324;" rowspan="3">결제 </th>
            <td class="text-center " style="width: 25%;border: 1px dotted #222324;">담당</td>       
            <td class="text-center" style="width: 25%;border: 1px dotted #222324;">원장</td>
        </tr>
        <tr >
            <td class="text-center" style="border: 1px dotted #222324;">
                {% if gdraft.drs_status_C == '결재완료' %}
                    <img src="{% static 'img/success.png' %}" alt="결재완료" width="50" height="50"> 
                {% elif gdraft.drs_status_C == '반려'  %}
                    <img src="{% static 'img/reject.png' %}" alt="반려" width="50" height="50"> 
                {% elif gdraft.drs_status_C == '결재대기'  %}
                                   <br>
                {% endif %}
                
            </td>          
            <td class="text-center" style="border: 1px dotted #222324;">
                {% if gdraft.drs_status_D == '결재완료' %}
                    <img src="{% static 'img/success.png' %}" alt="결재완료" width="50" height="50"> 
                {% elif gdraft.drs_status_D == '반려'  %}
                    <img src="{% static 'img/reject.png' %}" alt="반려" width="50" height="50"> 
                {% elif gdraft.drs_status_D == '결재대기'  %}
                                
                {% endif %}
                
            </td>
        </tr>
        <tr >
            <td class="text-center" style="border: 1px dotted #222324;"> <a href="#" class="btn btn-success" id="ch_check" data-id="{{ gdraft.dr_idx }}">결재</a> </td>          
            <td class="text-center" style="border: 1px dotted #222324;"> <a href="#" class="btn btn-success" id="review_check" data-id="{{ gdraft.dr_idx }}">결재</a> </td>
          
            
        </tr>
    </table>
</div>

<div class="container my-3" style="display: flow-root;">
    <!-- message 표시 -->
    {% if messages %}
    <div class="alert alert-danger my-3" role="alert">
    {% for message in messages %}
        <strong>{{ message.tags }}</strong>
        <ul><li>{{ message.message }}</li></ul>
    {% endfor %}
    </div>
    {% endif %}
    <!-- 질문 -->
     
    <h2 class="border-bottom py-2">{{ gdraft.dr_title }}</h2>     
    <div class="mb-3">문서번호 : {{ gdraft.dr_no}}    </div>   
    <div class="mb-3">작성자 : {{ gdraft.dr_id.username}}    </div>
    <div class="mb-3">기안일 : {{ gdraft.dr_date }}</div>
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text" >{{ gdraft.dr_content|mark }}</div>
            <!-- <div class="my-3">
                <ul>
            {% for qcomment in qcomment_list %}                
                    <li>{{qcomment.content}} ({{qcomment.create_date}})</li>
            {%endfor%}
            </ul> 
            </div>-->
        
        </div>
    </div>
    <div class="mb-3">
            <label for="subject" class="form-label">저장상태</label>
            {{ gdraft.dr_save_status}}
    </div>  
    {%if gdraft.drs_comment_C != '' %}
    <div class="mb-3">담당자 의견 : {{ gdraft.drs_comment_C }}</div>
    {%endif%}
    {%if gdraft.drs_comment_D != '' %}
    <div class="mb-3">임원 의견 : {{ gdraft.drs_comment_D }}</div>
    {%endif%}
    <div class="mb-3">관련 파일 : <a href="/gdraft/download?path={{ gdraft.dr_attachfile}}">{{gdraft.dr_attachfile}}</a> </div>    
    <div class="mb-3">최종 결재상태: {{ t_dts_status }}</div>
    <div class="my-3">
                
        {% if request.user  == gdraft.dr_id %} 
        <a href="{% url 'gdraft:gdraft_modify' gdraft.dr_idx %}" class="btn btn-sm btn-outline-secondary">수정</a>
        <a href="javascript:void(0)"  class="delete btn btn-sm btn-outline-secondary" data-uri="{% url 'gdraft:gdraft_delete' gdraft.dr_idx %}">삭제</a>
        {%endif%}
        <a href="{% url 'gdraft:index' %}" class="btn btn-sm btn-outline-secondary">목록</a>
    </div>
</div>
 <input type="hidden" name="gdraft_status" id="gdraft_status" value="{{ gdraft.dr_save_status }}">
 <input type="hidden" name="t_dts_status" id="t_dts_status" value="{{ t_dts_status }}">
<!--모달 -->
<div class="modal fade" id="myModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">        
      <form method="post" action="{% url 'gdraft:gstatus_submit'  %}">
        {% csrf_token %}
        <div class="modal-body">
         {% csrf_token %}
      <!-- 오류표시 Start -->
        {% if form.errors %}
        <div class="alert alert-danger" role="alert">
            {% for field in form %}
            {% if field.errors %}
            <div>
                <strong>{{ field.label }}</strong>
                {{ field.errors }}
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        <!-- 오류표시 End -->
       
        <div class="mb-3">
            <label for="dr_status" class="form-label">결재상태</label>
            <select  class="form-control" name="dr_status" id="dr_status">
                <option value='결재대기' {% if '결재대기' == dts_status %}selected{% endif %}>결재대기</option>
                <option value='결재완료' {% if '결재완료' == dts_status %}selected{% endif %}>결재완료</option>
                <option value='반려' {% if '반려' == dts_status %}selected{% endif %}>반려</option>
            </select>
            
        </div>
        <div class="mb-3">
            <label for="drs_comment" class="form-label">결재의견</label>
            <textarea class="form-control" name="drs_comment" id="drs_comment" rows="3">{{ dts_comment }}</textarea>
        </div>
        <input type="hidden" name="dr_idx" id="dr_idx" value="">
        <input type="hidden" name="jik_gread" id="jik_gread" value="">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="status_submit()">확인</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </form>
    </div>
  </div>
</div>
    

{% endblock %}
{% block script %}

<script type='text/javascript'>
const gdraft_modal = new bootstrap.Modal(document.getElementById('myModal'), {
  keyboard: false
})

const status_submit = function() {
        dr_idx = document.getElementById("dr_idx").value;
        jik_gread = document.getElementById("jik_gread").value;
        dr_status = document.getElementById("dr_status").value;
        drs_comment = document.getElementById("drs_comment").value;
        $.ajax({
        type:'POST',
        url:"{% url 'gdraft:gstatus_submit' %}",
        data:{
            'dr_idx': dr_idx,
            'jik_gread': jik_gread ,
            'dr_status': dr_status,
            'drs_comment': drs_comment
            },
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        success:function(json){            
            gMsg = json.msg;           
            if (gMsg){
                alert(gMsg);
            }
            closeModal = bootstrap.Modal.getInstance(document.getElementById('myModal'));
            closeModal.hide();
            location.reload();
            

        },
        error : function(xhr,errmsg,err) {
        console.log(xhr.status + ": " + xhr.responseText); 
        }
   });
}

const review_elements = document.getElementById("review_check");
    review_elements.addEventListener('click', function() {  
        const dr_idx = this.getAttribute('data-id');
        document.getElementById('dr_idx').value = dr_idx;
        document.getElementById('jik_gread').value = 3; //담당자 또는 부장 
        gdraft_status = document.getElementById("gdraft_status").value;
        

       

       if ("{{ user_jik_gread }}" != '3') {
            alert(" 결재 권한이 없습니다.");
            return;
        }  
        
        if (gdraft_status != '작성완료') {
            alert(" 작성완료된 기안서만 결재할 수 있습니다.");
            return;
        }
        gdraft_modal.show();        
    });

const status_elements = document.getElementById("ch_check");
    status_elements.addEventListener('click', function() {        
        const dr_idx = this.getAttribute('data-id');
        document.getElementById('dr_idx').value = dr_idx;
        document.getElementById('jik_gread').value = 2; //담당자 또는 부장
        gdraft_status = document.getElementById("gdraft_status").value;
        t_dts_status = document.getElementById("t_dts_status").value;

       
        

       if ("{{ user_jik_gread }}" != '2') {
            alert(" 결재 권한이 없습니다.");
            return;
        }
        if (gdraft_status != '작성완료') {
            alert(" 작성완료된 기안서만 결재할 수 있습니다.");
            return;
        }
        if( t_dts_status == '결재완료') {
            alert("원장이 결재완료 된 기안서는 다시 결재할 수 없습니다.");
            return;
        }
        gdraft_modal.show();        
    });

const delete_elements = document.getElementsByClassName("delete");
Array.from(delete_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("정말로 삭제하시겠습니까?")) {
            location.href = this.dataset.uri;
        };
    });
});
/*
const recommend_elements = document.getElementsByClassName("recommend");
Array.from(recommend_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("정말로 추천하시겠습니까?")) {
            location.href = this.dataset.uri;
        };
    });
});

*/

/*
const page_elements = document.getElementsByClassName("page-link");
Array.from(page_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        document.getElementById('dpage').value = this.dataset.page;
        document.getElementById('searchForm').submit();
    });
});
*/



//댓글
/* 
const comment_elements = document.getElementById("btn_qcomment");

    comment_elements.addEventListener('click', function() {
         $("#qcomment_form").show()        
    });

//댓글

        
        
*/
/* 

function acomment(answerid) {    
    $(".acomment_form").hide();    
    $("#acomment_form_"+answerid).show()
    
}
*/
</script>
{% endblock %}